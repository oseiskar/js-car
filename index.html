<!DOCTYPE html>
<html>
<head>
<title>JS car</title>
<meta charset="utf-8"/>
</head>
<body>
<svg width="1000" height="800">
</svg>
<br/>
<button onclick="stop()">Stop</button>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.9.0/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/5.4.2/math.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.5.1/dist/tf.min.js"> </script>
<script src="math-helpers.js"></script>
<script src="physics/car.js"></script>
<script src="physics/track.js"></script>
<script src="steering/manual.js"></script>
<script src="steering/pid.js"></script>
<script src="steering/ai-rubber-band.js"></script>
<script src="steering/policy-network.js"></script>
<script src="steering/ai-rl.js"></script>
<script src="render.js"></script>
<script>
'use strict';

const track = new Track({ collisionReset: 1000 });
track.addCar(manualSteering(), 'You');
//track.addCar(pidSteering(track.points), 'Fixed-velocity PID');
track.addCar(plannedVelocityRubberBandPidSteering(
  track.points, track.trackWidth, track.cars[0].model.properties),
  'Planned-route PID');
track.addCar(reinforcementLearningSteering(track.points), 'RL (tf.js)');

const svg = d3.select('svg');
const renderer = buildTrackRenderer(track, svg,
  parseInt(svg.style('width'),10),
  parseInt(svg.style('height'),10));

let t = new Date();
let deltaTime = 0.0;
let stopped = false;

function draw() {
  if (stopped) return;

  const MAX_DT = 0.2;

  const t0 = t;
  t = new Date();
  const curDt = (t - t0) * 1e-3;

  if (curDt > MAX_DT) {
    console.log('animation slow, paused or in background');
  } else {
    deltaTime += curDt;
  }

  if (deltaTime > MAX_DT) {
    console.warn('simulation lag detected');
    deltaTime = 0;
  }

  while (deltaTime >= track.deltaT) {
    deltaTime -= track.deltaT;
    track.move();
  }

  renderer();
  requestAnimationFrame(draw);
}
draw();

function stop() {
  stopped = true;
  track.stop();
}

</script>
</body>
</html>
